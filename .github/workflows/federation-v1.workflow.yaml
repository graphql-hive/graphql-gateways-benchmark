name: federation-v1
on:
  pull_request: {}
  workflow_dispatch: {}

concurrency:
  group: federation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  subgraphs:
    runs-on: ubuntu-24.04
    name: subgraphs
    steps:
      - name: checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5

      - name: setup rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - uses: Swatinem/rust-cache@v2
        
      - name: run subgraphs
        run: |
          make run-subgraphs &

  decide-runner:
    needs: subgraphs
    uses: ./.github/workflows/decide-runner.template.yaml

  constant-vus-over-time:
    needs:
      - decide-runner
      - subgraphs
    strategy:
      fail-fast: false
      matrix:
        directory:
          - apollo-server
          - apollo-router
          - hive-gateway
          - hive-gateway-bun
          - hive-router
          - cosmo
          - mercurius
          - grafbase
    uses: ./.github/workflows/benchmark.template.yaml
    with:
      gateway: ${{ matrix.directory }}
      vu: 300
      time: ${{ github.event_name == 'pull_request' && '30s' || '60s' }}
      scenarioName: constant-vus-over-time
      runner: ${{ needs.decide-runner.outputs.runner }}
      cpuLimit: 3
      memoryLimit: 6gb
      mode: constant

  constant-vus-over-time-report:
    needs: constant-vus-over-time
    uses: ./.github/workflows/report.template.yaml
    secrets: inherit
    with:
      scenarioName: constant-vus-over-time

  constant-vus-subgraphs-delay:
    needs:
      - decide-runner
      - subgraphs
    strategy:
      fail-fast: false
      matrix:
        directory:
          - apollo-server
          - apollo-router
          - hive-gateway
          - hive-gateway-bun
          - cosmo
          - mercurius
          - grafbase
    uses: ./.github/workflows/benchmark.template.yaml
    with:
      gateway: ${{ matrix.directory }}
      vu: 300
      time: ${{ github.event_name == 'pull_request' && '30s' || '60s' }}
      scenarioName: constant-vus-subgraphs-delay
      runner: ${{ needs.decide-runner.outputs.runner }}
      cpuLimit: 3
      memoryLimit: 6gb
      subgraphDelayRange: "40~150"
      mode: constant

  constant-vus-subgraphs-delay-report:
    needs: constant-vus-subgraphs-delay
    uses: ./.github/workflows/report.template.yaml
    secrets: inherit
    with:
      scenarioName: constant-vus-subgraphs-delay

  constant-vus-subgraphs-delay-resources:
    needs:
      - decide-runner
      - subgraphs
    strategy:
      fail-fast: false
      matrix:
        directory:
          - apollo-server
          - apollo-router
          - hive-gateway
          - hive-gateway-bun
          - cosmo
          - mercurius
          - grafbase
    uses: ./.github/workflows/benchmark.template.yaml
    with:
      gateway: ${{ matrix.directory }}
      vu: 500
      time: ${{ github.event_name == 'pull_request' && '30s' || '60s' }}
      scenarioName: constant-vus-subgraphs-delay-resources
      runner: ${{ needs.decide-runner.outputs.runner }}
      cpuLimit: 4
      memoryLimit: 8gb
      subgraphDelayRange: "40~150"
      mode: constant

  constant-vus-subgraphs-delay-resources-report:
    needs: constant-vus-subgraphs-delay-resources
    uses: ./.github/workflows/report.template.yaml
    secrets: inherit
    with:
      scenarioName: constant-vus-subgraphs-delay-resources

  ramping-vus:
    needs:
      - decide-runner
      - subgraphs
    strategy:
      fail-fast: false
      matrix:
        directory:
          - apollo-server
          - apollo-router
          - hive-gateway
          - hive-gateway-bun
          - cosmo
          - mercurius
          - grafbase
    uses: ./.github/workflows/benchmark.template.yaml
    with:
      gateway: ${{ matrix.directory }}
      vu: 2000
      time: 60s
      scenarioName: ramping-vus
      runner: ${{ needs.decide-runner.outputs.runner }}
      cpuLimit: 4
      memoryLimit: 8gb
      mode: stress

  ramping-vus-report:
    needs: ramping-vus
    uses: ./.github/workflows/report.template.yaml
    secrets: inherit
    with:
      scenarioName: ramping-vus
